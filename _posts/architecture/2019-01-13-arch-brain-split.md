---
layout: post
title: 脑裂问题以及如何避免
category: arch
comments: false
---

## 一、脑裂（brain-split）和危害
脑裂是指在主备切换时，由于切换不彻底或其他原因，导致客户端和Slave误以为出现两个active master，最终使得整个集群处于混乱状态。

例如，在“双机热备”高可用（HA）系统中，当联系2个节点的“心跳线”断开时，本来为一整体、动作协调的HA系统，就分裂成为2个独立的个体。由于相互失去了联系，都以为是对方出了故障，2个节点上的HA软件像“裂脑人”一样，“本能”地**争抢“共享资源”**、争起“应用服务”，就会发生严重后果：或者**共享资源被瓜分、2边“服务”都起不来了**；或者2边“服务”都起来了，但同时读写“共享存储”，导致**数据损坏**（常见如数据库轮询着的联机日志出错）。


## 二、避免手段和解决方法
为了避免出现脑裂，可采用下面的预防措施：

- 添加冗余的心跳线，例如双线条线。尽量减少“裂脑”发生机会。
- 启用磁盘锁。正在服务一方锁住共享磁盘，“裂脑”发生时，让对方完全“抢不走”共享磁盘资源。但使用锁磁盘也会有一个不小的问题，如果占用共享盘的一方不主动“解锁”，另一方就永远得不到共享磁盘。现实中假如服务节点突然死机或崩溃，就不可能执行解锁命令。后备节点也就接管不了共享资源和应用服务。于是有人在HA中设计了“智能”锁。即，正在服务的一方只在发现心跳线全部断开（察觉不到对端）时才启用磁盘锁。平时就不上锁了。
- 设置仲裁机制。例如设置参考IP（如网关IP），当心跳线完全断开时，2个节点都各自ping一下参考IP，不通则表明断点就出在本端，不仅“心跳”、还兼对外“服务”的本端网络链路断了，即使启动（或继续）应用服务也没有用了，那就主动放弃竞争，让能够ping通参考IP的一端去起服务。更保险一些，ping不通参考IP的一方干脆就自我重启，以彻底释放有可能还占用着的那些共享资源。

解决脑裂问题，通常采用隔离(Fencing)机制，包括三个方面：

- 共享存储fencing：确保只有一个Master往共享存储中写数据。
- 客户端fencing：确保只有一个Master可以响应客户端的请求。
- Slave fencing：确保只有一个Master可以向Slave下发命令。

Hadoop公共库中对外提供了两种fenching实现，分别是sshfence和shellfence（缺省实现），其中sshfence是指通过ssh登陆目标Master节点上，使用命令fuser将进程杀死（通过tcp端口号定位进程pid，该方法比jps命令更准确），shellfence是指执行一个用户事先定义的shell命令（脚本）完成隔离。